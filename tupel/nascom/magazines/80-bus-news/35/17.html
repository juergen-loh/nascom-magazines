<?php columnStart(1); ?>
<p>
3; If &ldquo;!&rdquo; hale for debug
</p>
<p>
yin8:
</p>
<p>
weg
</p>
<p>
cp
fronz,yind
halt
</p>
<p>
; If &ldquo;R&rdquo; handshake (not usually needed)
</p>
<p>
yind:
</p>
<p>
No input from keyboard
</p>
<p>
if cent
jr tin
else
</p>
<p>
ep WR
</p>
<p>
jr nz,tin
in a,(pd2)
jr tinx
endif
</p>
<p>
&gt;
</p>
<p>
Does not apply unless host uses interrupt lines
</p>
<p>
3
3 Test if chars are waiting
</p>
<p>
noin:
</p>
<p>
Id a,(wait-1)
ep mt ott
</p>
<p>
jr nz,n6
</p>
<p>
ld a,(wait)
ep Hon
</p>
<p>
jr nz,n6
</p>
<p>
; None waiting, so test if some spare
</p>
<p>
: Still
</p>
<p>
n4a:
</p>
<p>
ndb:
</p>
<p>
xor a
push af
</p>
<p>
ld a,(spare-1)
cp won
</p>
<p>
jr nz,n4
</p>
<p>
ld a,(spare)
ep tou
</p>
<p>
jr z,n5
</p>
<p>
some spare so allow PIO input
</p>
<p>
if cent
ei
</p>
<p>
xor a
</p>
<p>
out (pdi),a
ld a,3
dec a
</p>
<p>
4r nz,n4a
1d a,Olh
out (pdl),a
ld a,20
dec a
</p>
<p>
jr nz,n4b
di
</p>
<p>
else
</p>
<p>
ei
</p>
<p>
nop
</p>
<p>
nop
</p>
<p>
di
</p>
<p>
endif
</p>
<p>
pop af
dec a
</p>
<p>
jr onz,n3
qr tinx
</p>
<p>
Enable interrupts
</p>
<p>
Show printer not busy
</p>
<p>
Allow time for host to realise (assume tight loop)
</p>
<p>
Show printer busy again
</p>
<p>
Allow plenty of time for host to send data
</p>
<p>
Disable interrupts
</p>
<p>
Enable interrupts
</p>
<p>
Disable interrupts
</p>
<p>
Loop
</p>
<p>
; Some waiting, so test if halted
</p>
<p>
n6: ld a,(headh)
</p>
<p>
won,
</p>
<p>
cp
jr nz,n2
</p>
<p>
3 Chars are waiting for output
</p>
<p>
ld a,(hl)
5; Decompress spaces
bit 7,a
jr z,p4
ep 80h
jr z,p3
dec (hi)
ld a,&rdquo; &ldquo;
ir p6e
p3: ld a,&rdquo; &ldquo;
ld (hl),a
3 Add 1 to Spare
p4: push af
call sparep
pop af
</p>
<p>
3; Test for end of buffer
</p>
<p>
inc hl
</p>
<p>
or a
</p>
<p>
sbe hil,be
add hl,be
jr nz,p6
ld hi,stk
</p>
<p>
3; Subtract 1 from Waiting
</p>
<p>
pe: push af
call waitm
pop af
</p>
<p>
; Call output routine
</p>
<p>
call out
jr tinx
</p>
<p>
&gt;
</p>
<p>
Includes EI/DI
</p>
<p>
3 ***kkk INTERRUPT HANDLING INPUT ROUTINE ***%*
</p>
<p>
procl: push af
push hl
if cent
id a,Oih
out (pdl),a
endif
in a,(pd2)
and 07fh
ep woe
ir nz,pr5
; Compress blanks
ld a,(de)
bit 7,a
jr z,pr4
ep Offh
jv z,pr4
</p>
<p>
en om oe
</p>
<p>
Set port A bit 0 to show busy
</p>
<p>
Get data
Strip parity
Check for blank
</p>
<p>
Character in buffer
Test for first blank
</p>
<p>
Test for too many blanks
</p>
<p>
17
</p>
<?php columnEnd(1); ?>
